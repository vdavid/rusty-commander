name: CI

on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - main

jobs:
    rust-checks:
        name: Rust
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install mise
              uses: jdx/mise-action@v2

            - name: Install tools with mise
              run: mise install

            - name: Cache Cargo
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/registry/cache
                  key: ${{ runner.os }}-cargo-${{ hashFiles('apps/desktop/src-tauri/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Install Tauri dependencies (Linux)
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Build check tool
              run: go build -o check .
              working-directory: ./scripts/check

            - name: Check rustfmt
              run: ./scripts/check/check --check rustfmt --ci

            - name: Run clippy
              run: ./scripts/check/check --check clippy --ci

            - name: Run cargo-audit
              run: ./scripts/check/check --check cargo-audit --ci

            - name: Run cargo-deny
              run: ./scripts/check/check --check cargo-deny --ci

            - name: Install nightly toolchain (for cargo-udeps)
              run: rustup toolchain install nightly

            - name: Run cargo-udeps
              run: ./scripts/check/check --check cargo-udeps --ci

            - name: Run Rust tests
              run: ./scripts/check/check --check rust-tests --ci

    svelte-checks:
        name: Svelte
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install mise
              uses: jdx/mise-action@v2

            - name: Install tools with mise
              run: mise install

            - name: Cache pnpm
              uses: actions/cache@v4
              with:
                  path: ~/.pnpm-store
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('apps/desktop/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
              working-directory: ./apps/desktop

            - name: Generate SvelteKit types
              run: pnpm exec svelte-kit sync
              working-directory: ./apps/desktop

            - name: Build check tool
              run: go build -o check .
              working-directory: ./scripts/check

            - name: Check Prettier
              run: ./scripts/check/check --check prettier --ci

            - name: Run ESLint
              run: ./scripts/check/check --check eslint --ci

            - name: Run Svelte tests
              run: ./scripts/check/check --check svelte-tests --ci

    e2e-tests:
        name: E2E Tests
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install mise
              uses: jdx/mise-action@v2

            - name: Install tools with mise
              run: mise install

            - name: Cache pnpm
              uses: actions/cache@v4
              with:
                  path: ~/.pnpm-store
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('apps/desktop/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
              working-directory: ./apps/desktop

            - name: Install Playwright browsers
              run: pnpm exec playwright install --with-deps chromium webkit
              working-directory: ./apps/desktop

            - name: Build check tool
              run: go build -o check .
              working-directory: ./scripts/check

            - name: Run E2E tests
              run: ./scripts/check/check --check e2e-tests --ci

    website-checks:
        name: Website
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install mise
              uses: jdx/mise-action@v2

            - name: Install tools with mise
              run: mise install

            - name: Cache pnpm
              uses: actions/cache@v4
              with:
                  path: ~/.pnpm-store
                  key: ${{ runner.os }}-pnpm-website-${{ hashFiles('apps/website/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-website-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
              working-directory: ./apps/website

            - name: Build website
              run: pnpm build
              working-directory: ./apps/website

            - name: Run Playwright tests
              run: pnpm test:e2e
              working-directory: ./apps/website

            - name: Run Lighthouse CI
              run: pnpm test:lighthouse
              working-directory: ./apps/website
              env:
                  LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

            - name: Upload Lighthouse report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: lighthouse-report
                  path: apps/website/.lighthouseci/
                  retention-days: 7
